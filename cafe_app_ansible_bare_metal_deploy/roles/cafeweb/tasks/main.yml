---
# Update the apt cache
- name: Update apt cache
  apt:
    update_cache: yes

# Install Apache and PHP packages
- name: Install Apache and PHP packages
  apt:
    name:
      - apache2
      - php
      - php-mysql
      - libapache2-mod-php
      - wget
      - tar
    state: present

# Ensure Apache is enabled and started
- name: Ensure Apache is enabled and started
  service:
    name: apache2
    state: started
    enabled: yes

# Ensure /var/www/html/mompopcafe directory exists
- name: Ensure /var/www/html/mompopcafe directory exists
  file:
    path: /var/www/html/mompopcafe
    state: directory
    mode: '0755'
    owner: www-data
    group: www-data

# Download the application tarball
- name: Download application code tarball
  get_url:
    url: "{{ app_tarball_url }}"
    dest: "{{ app_tarball_dest }}"

# Extract the tarball to /var/www/html/mompopcafe
- name: Extract application code to /var/www/html/mompopcafe
  unarchive:
    src: "{{ app_tarball_dest }}"
    dest: /var/www/html/mompopcafe
    remote_src: yes
    extra_opts: [--strip-components=1]  # optional: removes top-level folder inside tarball
  notify: Reload Apache

# Ensure /etc/cafe directory exists
- name: Ensure /etc/cafe directory exists
  file:
    path: /etc/cafe
    state: directory
    mode: '0755'

# Copy getAppParameters.php template to /etc/cafe
- name: Copy getAppParameters.php template to /etc/cafe
  template:
    src: "{{ get_app_parameters_src }}"
    dest: "{{ get_app_parameters_host_dest }}"
    mode: '0644'

# Copy getAppParameters.php template inside app directory
- name: Copy getAppParameters.php template to /var/www/html/mompopcafe/
  template:
    src: "{{ get_app_parameters_src }}"
    dest: "{{ get_app_parameters_dest }}"
    owner: www-data
    group: www-data
    mode: '0644'

# Update Apache configuration to point to mompopcafe
- name: Update Apache configuration
  template:
    src: "{{ apache_config_template }}"
    dest: /etc/apache2/sites-available/000-default.conf
  notify: Reload Apache
